import MigrationBase from './abstract/migration'
import type AWS from '../config/aws-config'
import { DynamoDBService } from '../services/dynamo-db.service'
import fs from 'fs'
import path from 'path'

export class CreateVulnerabilityTableMigration extends MigrationBase {
   private readonly dynamodbService: DynamoDBService;

  constructor() {
    super()
     this.dynamodbService = new DynamoDBService()
  }

  async up(): Promise<void> {
    const vulnerabilityTableParams: AWS.DynamoDB.CreateTableInput = {
      TableName: 'Vulnerability',
      KeySchema: [
        { AttributeName: 'companyId', KeyType: 'HASH' },
        { AttributeName: 'vulnerabilityId', KeyType: 'RANGE' }
      ],
      AttributeDefinitions: [
        { AttributeName: 'companyId', AttributeType: 'S' },
        { AttributeName: 'vulnerabilityId', AttributeType: 'S' },
      ],
      ProvisionedThroughput: {
        ReadCapacityUnits: 1,
        WriteCapacityUnits: 1
      },
    }

    const tableDescription =
      await this.dynamodbService.describeTable('Vulnerability')
    if (tableDescription?.Table !== undefined) {
      console.log('Table "Vulnerability" already exists. Skipping creation.')
      return
    }

    await this.dynamodbService.createTable(vulnerabilityTableParams)
    console.log('Creating Vulnerability table...')
  }

  async down(): Promise<void> {
    await this.dynamodbService.deleteTable('Vulnerability')
    console.log('Deleting Vulnerability table...')
  }

  async seed(): Promise<void> {
    const filePath = path.join(__dirname, 'seed', 'seed-vulnerabilities.json')
    const seed = JSON.parse(fs.readFileSync(filePath, 'utf-8'))

    if (seed.length > 0) {
      for (const vulnerability of seed) {
        await this.dynamodbService.putItem({
          TableName: 'Vulnerability',
          Item: {
            companyId: { S: vulnerability.companyId },
            vulnerabilityId: { S: vulnerability.vulnerabilityId },
            packageType: { S: vulnerability.packageType },
            packageName: { S: vulnerability.packageName },
            packageVersion: { S: vulnerability.packageVersion },
            description: { S: vulnerability.description },
            severity: { S: vulnerability.severity }
          }
        })
      }
      console.log('Seeding data into Vulnerability table...')
    }
  }
}
